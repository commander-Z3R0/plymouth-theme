#!/bin/bash
set -e

USER="sirr"
USER_HOME="/home/$USER"
GTK_CONFIG_DIR="$USER_HOME/.config/gtk-3.0"
GTK_CSS_FILE="$GTK_CONFIG_DIR/gtk.css"
WALLPAPER_PATH="/usr/share/backgrounds/wallpaper_sirros.png"

# Create the gtk-3.0 directory if it does not exist
if [ ! -d "$GTK_CONFIG_DIR" ]; then
  mkdir -p "$GTK_CONFIG_DIR"
  chown $USER:$USER "$GTK_CONFIG_DIR"
fi

# Create or overwrite gtk.css with the desired content
cat > "$GTK_CSS_FILE" << EOF
/*
 * Set a background for the lockscreen.
 */
phosh-lockscreen, .phosh-lockshield {
  background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                    url('file://$WALLPAPER_PATH');
  background-size: cover;
  background-position: center;
}

/*
 * Set a background for the app grid.
 */
phosh-app-grid {
  background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                    url('file://$WALLPAPER_PATH');
  background-size: cover;
  background-position: center;
}
EOF

# Apply correct user/group ownership to gtk.css
chown $USER:$USER "$GTK_CSS_FILE"

# Plymouth theme configuration
PLYMOUTH_THEME_NAME="sirros"
PLYMOUTH_THEME_PATH="/usr/share/plymouth/themes/$PLYMOUTH_THEME_NAME/$PLYMOUTH_THEME_NAME.plymouth"

echo "[+] Configuring Plymouth theme '$PLYMOUTH_THEME_NAME'..."
if [ -f "$PLYMOUTH_THEME_PATH" ]; then
    update-alternatives --install /usr/share/plymouth/themes/default.plymouth default.plymouth "$PLYMOUTH_THEME_PATH" 100
    update-alternatives --set default.plymouth "$PLYMOUTH_THEME_PATH"

    # Force Plymouth theme setting
    plymouth-set-default-theme sirros
    
    update-initramfs -u
    echo "[+] Plymouth updated successfully."
else
    echo "[!] File $PLYMOUTH_THEME_PATH not found."
fi

# Restart phosh to apply GTK config
echo "[+] Restarting phosh..."
systemctl restart phosh || echo "[!] Could not restart phosh. Please verify the service exists."

exit 0
